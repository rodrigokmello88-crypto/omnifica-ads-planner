<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Omnifica Ads Planner - Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *{box-sizing:border-box;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;}
    body{
      margin:0;
      min-height:100vh;
      background:#020617;
      color:#e5e7eb;
      display:flex;
      justify-content:center;
    }
    .wrap{
      width:100%;
      max-width:1050px;
      padding:16px 18px 24px;
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:12px;
    }
    header h1{
      font-size:18px;
      margin:0;
    }
    header a{
      color:#a5b4fc;
      font-size:12px;
      text-decoration:none;
    }
    header a:hover{text-decoration:underline;}
    .card{
      background:rgba(15,23,42,.95);
      border-radius:18px;
      padding:14px 16px;
      border:1px solid rgba(148,163,184,.4);
      box-shadow:0 18px 30px rgba(15,23,42,.85);
      margin-bottom:14px;
    }
    input{
      width:100%;
      padding:7px 9px;
      border-radius:10px;
      border:1px solid rgba(148,163,184,.5);
      background:rgba(15,23,42,.9);
      color:#f9fafb;
      font-size:13px;
      outline:none;
    }
    input:focus{
      border-color:#22c55e;
      box-shadow:0 0 0 1px rgba(34,197,94,.3);
    }
    button{
      padding:7px 10px;
      border-radius:999px;
      border:none;
      background:linear-gradient(135deg,#22c55e,#22d3ee);
      color:#020617;
      font-weight:600;
      cursor:pointer;
      font-size:13px;
    }
    button:hover{filter:brightness(1.05);}
    .status{font-size:12px;margin-top:4px;}
    .status.ok{color:#4ade80;}
    .status.err{color:#fb7185;}
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      margin-top:6px;
    }
    th,td{
      border-bottom:1px solid rgba(31,41,55,.9);
      padding:6px 4px;
      text-align:left;
    }
    th{font-size:11px;color:#9ca3af;}
    .badge{
      display:inline-block;
      padding:2px 7px;
      border-radius:999px;
      font-size:11px;
    }
    .badge.pending{background:rgba(252,211,77,.18);color:#facc15;}
    .badge.approved{background:rgba(34,197,94,.18);color:#4ade80;}
    .badge.blocked{background:rgba(248,113,113,.18);color:#fb7185;}
    .small-btn{
      padding:4px 7px;
      font-size:11px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      margin-right:4px;
    }
    .small-btn.approve{background:rgba(34,197,94,.15);color:#bbf7d0;border:1px solid rgba(34,197,94,.4);}
    .small-btn.block{background:rgba(248,113,113,.18);color:#fecaca;border:1px solid rgba(248,113,113,.4);}
    .small-btn.pending{background:rgba(252,211,77,.18);color:#facc15;border:1px solid rgba(252,211,77,.4);}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Área do Administrador</h1>
        <div style="font-size:12px;color:#9ca3af;">Aprovar contas após pagamento e controlar o status dos planos.</div>
      </div>
      <div>
        <a href="/">← Voltar para o site</a>
      </div>
    </header>

    <!-- LOGIN ADMIN -->
    <div class="card" id="admin-login-card">
      <div style="font-size:13px;margin-bottom:6px;">Digite a senha de administrador para acessar.</div>
      <input type="password" id="admin-password" placeholder="Senha ADMIN_PASSWORD configurada no Render" />
      <div style="margin-top:6px;">
        <button id="btn-admin-login">Entrar como admin</button>
      </div>
      <div id="admin-login-status" class="status"></div>
    </div>

    <!-- LISTA DE USUÁRIOS -->
    <div class="card" id="admin-users-card" style="display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-size:13px;font-weight:600;">Usuários cadastrados</div>
        <button id="btn-refresh" style="padding:5px 9px;font-size:11px;border-radius:999px;">Atualizar</button>
      </div>
      <div class="status" id="admin-users-status"></div>
      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>Nome</th>
              <th>E-mail</th>
              <th>Plano</th>
              <th>Status</th>
              <th>Criado em</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="users-body"></tbody>
        </table>
      </div>
      <div class="status" style="margin-top:6px;">
        Status <span class="badge pending">pending</span> = aguardando pagamento/aprovação ·
        <span class="badge approved">approved</span> = acesso liberado ·
        <span class="badge blocked">blocked</span> = acesso bloqueado.
      </div>
    </div>
  </div>

  <script>
    const loginCard = document.getElementById("admin-login-card");
    const usersCard = document.getElementById("admin-users-card");
    const pwdInput = document.getElementById("admin-password");
    const btnAdminLogin = document.getElementById("btn-admin-login");
    const loginStatus = document.getElementById("admin-login-status");

    const usersBody = document.getElementById("users-body");
    const usersStatus = document.getElementById("admin-users-status");
    const btnRefresh = document.getElementById("btn-refresh");

    let adminSecret = localStorage.getItem("omnifica_admin_secret") || "";

    async function adminLogin(password) {
      loginStatus.textContent = "Validando senha...";
      loginStatus.className = "status";
      try {
        const res = await fetch("/api/admin/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Erro ao autenticar.");
        adminSecret = password;
        localStorage.setItem("omnifica_admin_secret", password);
        loginStatus.textContent = "Autenticado com sucesso.";
        loginStatus.className = "status ok";
        loginCard.style.display = "none";
        usersCard.style.display = "block";
        loadUsers();
      } catch (err) {
        loginStatus.textContent = err.message;
        loginStatus.className = "status err";
      }
    }

    btnAdminLogin.addEventListener("click", () => {
      const pwd = pwdInput.value.trim();
      if (!pwd) {
        loginStatus.textContent = "Informe a senha.";
        loginStatus.className = "status err";
        return;
      }
      adminLogin(pwd);
    });

    async function loadUsers() {
      usersStatus.textContent = "Carregando usuários...";
      usersStatus.className = "status";
      usersBody.innerHTML = "";
      try {
        const res = await fetch("/api/admin/users", {
          headers: { "x-admin-secret": adminSecret },
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Erro ao carregar.");
        const users = data.users || [];
        if (!users.length) {
          usersBody.innerHTML = `<tr><td colspan="6">Nenhum usuário cadastrado ainda.</td></tr>`;
        } else {
          usersBody.innerHTML = "";
          users.forEach((u) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${u.name || "-"}</td>
              <td>${u.email || "-"}</td>
              <td>${(u.plan || "").toUpperCase()}</td>
              <td><span class="badge ${u.status}">${u.status}</span></td>
              <td>${u.createdAt ? new Date(u.createdAt).toLocaleString("pt-BR") : "-"}</td>
              <td>
                <button class="small-btn approve" data-id="${u.id}" data-status="approved">Aprovar</button>
                <button class="small-btn pending" data-id="${u.id}" data-status="pending">Pendente</button>
                <button class="small-btn block" data-id="${u.id}" data-status="blocked">Bloquear</button>
              </td>
            `;
            usersBody.appendChild(tr);
          });
        }
        usersStatus.textContent = "";
      } catch (err) {
        usersStatus.textContent = err.message;
        usersStatus.className = "status err";
      }
    }

    usersBody.addEventListener("click", async (e) => {
      const btn = e.target.closest("button.small-btn");
      if (!btn) return;
      const userId = btn.getAttribute("data-id");
      const status = btn.getAttribute("data-status");
      if (!confirm(`Alterar status deste usuário para "${status}"?`)) return;

      try {
        const res = await fetch("/api/admin/update-user-status", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-admin-secret": adminSecret,
          },
          body: JSON.stringify({ userId, status }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Erro ao atualizar.");
        loadUsers();
      } catch (err) {
        alert(err.message);
      }
    });

    btnRefresh.addEventListener("click", loadUsers);

    // Se já tiver adminSecret salvo, tenta entrar direto
    if (adminSecret) {
      loginCard.style.display = "none";
      usersCard.style.display = "block";
      loadUsers();
    }
  </script>
</body>
</html>
